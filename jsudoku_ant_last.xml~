<?xml version="1.0" encoding="UTF-8"?>

<project name="jSudoku" basedir="." default="jar">

	<!--Full name of the app-->
	<property name="app.name" value="jSudoku" />
	<property name="app.shortName" value="jSudoku" />
	<property name="app.version" value="1.0" />
	<property name="main.class" value="org.kdu.jsudoku.control.Controller" />
	<property name="main.path" value="org/kdu/jsudoku/control/Controller.class" />

	<!--Git variables-->
	<property name="classes.home" value="jSudoku/bin" />
	<property name="lib.home" value="${git.repo}/lib" />

	<!--Checkstyle variables-->
	<property name="checkstyle_ver" value="6.10.1" />
	<property name="checkstyle_dir" value="/var/lib/jenkins/checkstyle-${checkstyle_ver}/" />
	<property name="checkstyle_report" value="checkstyle_results.xml" />
		
	<!--Checkstyle-->
	<taskdef resource="com/puppycrawl/tools/checkstyle/ant/checkstyle-ant-task.properties" classpath="${checkstyle_dir}/checkstyle-${checkstyle_ver}-all.jar" />
	
	<path id="project.class.path">
		<pathelement path="${lib.home}/kduXtra.jar" />
		<pathelement path="${lib.home}/looks-1.3.2.jar" />
	</path>
	
	<!-- GIT Macro-->
	<macrodef name="git">
		<attribute name="command" />
		<attribute name="dir" default="" />
		<element name="args" optional="true" />
		<sequential>
			<echo message="git @{command}" />
			<exec executable="git" dir="@{dir}">
				<arg value="@{command}" />
				<args />
			</exec>
		</sequential>
	</macrodef>

	<target name="sub.compile" depends="sub.clear,git.getsource,checker">
		<echo message="INFO: Compiling ${app.name} - build ${app.version}..." />
		<mkdir dir="${classes.home}" />
		<javac source="1.7" srcdir="jSudoku/src" includeantruntime="false" destdir="${classes.home}" debug="yes">
			<classpath refid="project.class.path" />
		</javac>
		<echo message="OKAY: ${app.name} - build ${app.version} compiled." />
	</target>
	
	<target name="jar" depends="sub.compile,sub.manifest">
		<echo message="Generating jar file..." />
		<jar destfile="${app.name}.jar" basedir="${classes.home}" manifest="${classes.home}/META-INF/MANIFEST.MF">
			<zipfileset src="${lib.home}/kduXtra.jar" />
			<zipfileset src="${lib.home}/looks-1.3.2.jar" />
		</jar>
		<echo message="${app.name}.jar Generated!" />
	</target>
	
	<target xmlns:xalan="http://xml.apache.org/xslt" name="sub.manifest">
		<echo message="Generating manifest file..." />
		<mkdir dir="${classes.home}/META-INF" />
		<manifest mode="update" file="${classes.home}/META-INF/MANIFEST.MF">
			<attribute name="Implementation-Vendor" value="Carlos Eduardo Genz" />
			<attribute name="Implementation-Title" value="${app.name}" />
			<attribute name="Implementation-Version" value="${app.version}" />
			<attribute name="Main-Class" value="${main.class}" />
		</manifest>
		<echo message="Manifest file Generated!" />
	</target>
	
	<target name="sub.clear">
		<echo message="INFO: Performing initial cleanup." />
		<delete dir="jSudoku" />
		<delete file="${app.name}.jar" />
		<delete file="${checkstyle_report}" />
		<echo message="OKAY: Cleaning completed." />
	</target>
	
	<target name="git.getsource">
		<echo message="--------- Git credentials -----------" />
		<echo message="Destination folder: jSudoku" />
		<echo message="Source link: ssh://ec2-52-29-32-31.eu-central-1.compute.amazonaws.com/home/git/jSudoku" />
		<echo message="-------------------------------------" />
		<git command="clone">
			<args>
				<arg value="ssh://ec2-52-29-32-31.eu-central-1.compute.amazonaws.com/home/git/jSudoku" />
				<arg value="jSudoku" />
			</args>
		</git>
		<fail message="CRIT: Cloning Failed! The directory `jSudoku` does not exist.">
			<condition>
				<not>
					<available file="jSudoku" />
				</not>
			</condition>
		</fail>
		<echo message="OKAY: Repository cloned." />
	</target>
	
	<target name="checker">
		<echo message="INFO: Running Checkstyle on source code..." />
		<checkstyle config="${checkstyle_dir}/docs/sun_checks.xml" failOnViolation="false">
			<fileset dir="jSudoku/src" includes="**/*.java" />
			<formatter type="plain" />
			<formatter type="xml" toFile="${checkstyle_report}" />
		</checkstyle>
	</target>
	
</project>
